<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RFPD Enhanced Bot</title>
  </head>

  <body>
    <header>Welcome to RFPD Support Bot</header>

    <script type="text/javascript">
      function initEmbeddedMessaging() {
        try {
          embeddedservice_bootstrap.settings.language = "en_US";

          embeddedservice_bootstrap.init(
            "00DWr000005lheX", // Org Id
            "Bot_Service", // Deployment Name
            "https://arrowcrm--mergeuat.sandbox.my.site.com/ESWBotService1756717818662",
            {
              scrt2URL:
                "https://arrowcrm--mergeuat.sandbox.my.salesforce-scrt.com",
            }
          );

          // Wait for the messaging runtime to fully load before listening
          embeddedservice_bootstrap.addEventHandler(
            "onEmbeddedMessagingReady",
            function () {
              console.log("Enhanced Messaging is ready.");

              // Now attach conversation end event listener
              embeddedservice_bootstrap.addEventHandler(
                "onConversationEnded",
                function (event) {
                  console.log("ðŸ’¬ Chat Ended Event:", event);

                  const sessionId = event?.data?.recordId; // Correct path in enhanced bot

                  if (sessionId) {
                    console.log("Session ID:", sessionId);
                    window.open(
                      `https://arrow.secure.force.com/rfpdchatsurvey/apex/RFPDSurveyPage?sessionId=${sessionId}`,
                      "_blank"
                    );
                  } else {
                    console.warn("No session ID found. Opening survey directly.");
                    window.open(
                      "https://arrow.secure.force.com/rfpdchatsurvey/apex/RFPDSurveyPage",
                      "_blank"
                    );
                  }
                }
              );
            }
          );
        } catch (err) {
          console.error("Error loading Embedded Messaging: ", err);
        }
      }
    </script>

    <script
      type="text/javascript"
      src="https://arrowcrm--mergeuat.sandbox.my.site.com/ESWBotService1756717818662/assets/js/bootstrap.min.js"
      defer
      onload="initEmbeddedMessaging()"
    ></script>
  </body>
</html>
